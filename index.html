<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Under Construction - Obra Dinn Style</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cutive+Mono&display=swap" rel="stylesheet">

    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: 'Cutive Mono', monospace;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* --- Retro UI --- */
        #ui-layer {
            position: fixed;
            bottom: 40px;
            right: 40px;
            z-index: 10;
            text-align: center;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 25px;
            border: 2px solid currentColor; /* Takes text color */
            color: white; /* Default, will be overridden by JS */
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            transition: color 0.3s, border-color 0.3s;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 300px;
        }

        .title-block {
            position: fixed;
            top: 40px;
            left: 50%; /* Center it */
            transform: translateX(-50%);
            z-index: 10;
            pointer-events: none;
            color: white; /* Overridden by JS */
            mix-blend-mode: difference;
            text-align: center;
            width: 80%;
        }

        h1 {
            font-size: 2.5rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            line-height: 1;
        }

        .subtitle {
            font-size: 1.2rem;
            margin-top: 10px;
            opacity: 0.9;
            text-transform: uppercase;
            min-height: 1.5em;
            transition: opacity 0.2s;
        }

        .typing-cursor::after {
            content: '█';
            animation: blink 1s infinite;
            margin-left: 5px;
        }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* Controls */
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
        }

        label {
            display: block;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        select {
            background: transparent;
            border: 1px solid currentColor;
            color: currentColor;
            padding: 8px 12px;
            font-family: 'Cutive Mono', monospace;
            font-size: 1rem;
            text-transform: uppercase;
            cursor: pointer;
            outline: none;
            width: 100%;
            appearance: none;
        }

        select:hover { opacity: 0.8; }

        .select-wrapper { position: relative; width: 100%; }
        .select-wrapper::after {
            content: '▼';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 0.7em;
        }

        /* Instructions */
        .instructions {
            position: fixed;
            top: 40px;
            right: 40px;
            text-align: right;
            z-index: 10;
            color: white;
            mix-blend-mode: difference;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        /* Left Header Text */
        .left-header {
            position: fixed;
            top: 40px;
            left: 40px;
            text-align: left;
            z-index: 10;
            color: white;
            mix-blend-mode: difference;
            font-size: 0.8rem;
            line-height: 1.5;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Footer Left Text */
        .footer-left {
            position: fixed;
            bottom: 40px;
            left: 40px;
            text-align: left;
            z-index: 10;
            color: white;
            mix-blend-mode: difference;
            font-size: 0.8rem;
            line-height: 1.5;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <div class="left-header" id="left-header">
        SPACEFARM<br>2026
    </div>

    <div class="footer-left" id="footer-left">
        ALL RIGHTS RESERVED
    </div>

    <div class="title-block" id="main-title">
        <h1>Under Construction</h1>
        <div class="subtitle typing-cursor" id="system-message">System Rendering...</div>
    </div>

    <div class="instructions" id="instructions">
        DRAG TO ROTATE VIEW<br>
        SCROLL TO ZOOM
    </div>

    <div id="ui-layer">
        <!-- Monitor Select -->
        <div class="control-group">
            <label for="monitor-select">Monitor</label>
            <div class="select-wrapper">
                <select id="monitor-select">
                    <option value="macintosh">Macintosh</option>
                    <option value="ibm5151">IBM 5151</option>
                    <option value="zenith">Zenith ZVM 1240</option>
                    <option value="commodore">Commodore 1084</option>
                    <option value="ibm8503">IBM 8503</option>
                    <option value="lcd">LCD</option>
                </select>
            </div>
        </div>

        <!-- Output Select -->
        <div class="control-group">
            <label for="output-select">Output</label>
            <div class="select-wrapper">
                <select id="output-select">
                    <option value="smooth">Smooth</option>
                    <option value="sharp" selected>Sharp (Default)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

        // --- Monitor Presets (Exact Hex) ---
        const PRESETS = {
            macintosh: {
                // "Dirty Ice" - Slight greenish hue
                light: new THREE.Color(0xE0E5DC),
                dark: new THREE.Color(0x2D332D),
                threshold: 0.5
            },
            ibm5151: {
                // Classic Phosphor Green
                light: new THREE.Color(0x33FF33),
                dark: new THREE.Color(0x002200),
                threshold: 0.5
            },
            zenith: {
                // Amber
                light: new THREE.Color(0xFFB000),
                dark: new THREE.Color(0x2D1B00),
                threshold: 0.5
            },
            commodore: {
                // C64-ish Blue Tint
                light: new THREE.Color(0x88CCFF),
                dark: new THREE.Color(0x000055),
                threshold: 0.45
            },
            ibm8503: {
                // Stark Black and White
                light: new THREE.Color(0xFFFFFF),
                dark: new THREE.Color(0x050505),
                threshold: 0.6
            },
            lcd: {
                // Lower contrast, smoother greyish
                light: new THREE.Color(0xC0C5CE),
                dark: new THREE.Color(0x1D1F21),
                threshold: 0.5
            }
        };

        // --- Configuration ---
        let currentPreset = PRESETS.macintosh;
        let currentOutput = 'sharp';
        let logoTexture = null; // Defined at top level to avoid ReferenceError
        let logoGroup = null;

        // --- Scene Setup ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x808080);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 7);

        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1.0;

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(10, 10, 5);
        scene.add(dirLight);

        const pointLight = new THREE.PointLight(0xffffff, 1);
        pointLight.position.set(-5, 0, 2);
        scene.add(pointLight);

        // --- Objects ---

        // 1. Logo (3D Text)
        logoGroup = new THREE.Group();
        scene.add(logoGroup);

        const loader = new FontLoader();
        loader.load('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/fonts/helvetiker_bold.typeface.json', function (font) {
            const textGeo = new TextGeometry('SPACEFARM', {
                font: font,
                size: 1.2,
                height: 0.2,
                curveSegments: 4,
                bevelEnabled: false
            });

            textGeo.computeBoundingBox();
            const centerOffset = - 0.5 * (textGeo.boundingBox.max.x - textGeo.boundingBox.min.x);
            textGeo.translate(centerOffset, -0.4, 0);

            // Use MeshLambertMaterial so it reacts to light like the debris
            const textMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff });
            const textMesh = new THREE.Mesh(textGeo, textMaterial);
            logoGroup.add(textMesh);
        });

        // 2. Floating Debris
        const debrisGroup = new THREE.Group();
        const debrisMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff });

        // --- Post Processing ---
        const composer = new EffectComposer(renderer);
        const renderPass = new RenderPass(scene, camera);
        composer.addPass(renderPass);

        // Custom Dither Shader
        const DitherShader = {
            uniforms: {
                'tDiffuse': { value: null },
                'uResolution': { value: new THREE.Vector2(window.innerWidth, window.innerHeight) },
                'uLightColor': { value: currentPreset.light },
                'uDarkColor': { value: currentPreset.dark },
                'uThreshold': { value: currentPreset.threshold },
                'uPixelSize': { value: 1.0 } // Controlled by Output
            },
            vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tDiffuse;
                uniform vec2 uResolution;
                uniform vec3 uLightColor;
                uniform vec3 uDarkColor;
                uniform float uThreshold;
                uniform float uPixelSize;

                varying vec2 vUv;

                // 4x4 Bayer Matrix
                float bayer4x4(vec2 p) {
                    int x = int(mod(p.x, 4.0));
                    int y = int(mod(p.y, 4.0));
                    if (x == 0) { if (y == 0) return 0.0/16.0; if (y == 1) return 12.0/16.0; if (y == 2) return 3.0/16.0; return 15.0/16.0; }
                    if (x == 1) { if (y == 0) return 8.0/16.0; if (y == 1) return 4.0/16.0; if (y == 2) return 11.0/16.0; return 7.0/16.0; }
                    if (x == 2) { if (y == 0) return 2.0/16.0; if (y == 1) return 14.0/16.0; if (y == 2) return 1.0/16.0; return 13.0/16.0; }
                    if (x == 3) { if (y == 0) return 10.0/16.0; if (y == 1) return 6.0/16.0; if (y == 2) return 9.0/16.0; return 5.0/16.0; }
                    return 0.0;
                }

                void main() {
                    // Pixelize coordinate
                    vec2 pixelCoord = floor(gl_FragCoord.xy / uPixelSize);

                    // Sample texture
                    vec4 texel = texture2D(tDiffuse, vUv);

                    float lum = dot(texel.rgb, vec3(0.299, 0.587, 0.114));
                    float ditherValue = bayer4x4(pixelCoord);

                    vec3 finalColor = (lum < ditherValue) ? uDarkColor : uLightColor;
                    gl_FragColor = vec4(finalColor, 1.0);
                }
            `
        };

        const ditherPass = new ShaderPass(DitherShader);
        composer.addPass(ditherPass);

        // --- UI Logic ---
        const monitorSelect = document.getElementById('monitor-select');
        const outputSelect = document.getElementById('output-select');
        const uiLayer = document.getElementById('ui-layer');
        const titleBlock = document.getElementById('main-title');
        const instructions = document.getElementById('instructions');
        const leftHeader = document.getElementById('left-header');
        const footerLeft = document.getElementById('footer-left');

        function updateSettings() {
            // Monitor Colors
            const preset = PRESETS[monitorSelect.value];
            ditherPass.uniforms.uLightColor.value = preset.light;
            ditherPass.uniforms.uDarkColor.value = preset.dark;
            ditherPass.uniforms.uThreshold.value = preset.threshold;

            // Output Mode (Pixel Size)
            const outputMode = outputSelect.value;
            if (outputMode === 'sharp') {
                ditherPass.uniforms.uPixelSize.value = 2.0; // Chunkier pixels
                if(logoTexture) {
                    logoTexture.minFilter = THREE.NearestFilter;
                    logoTexture.magFilter = THREE.NearestFilter;
                    logoTexture.needsUpdate = true;
                }
            } else {
                ditherPass.uniforms.uPixelSize.value = 1.0; // Native resolution
                if(logoTexture) {
                    logoTexture.minFilter = THREE.LinearFilter;
                    logoTexture.magFilter = THREE.LinearFilter;
                    logoTexture.needsUpdate = true;
                }
            }

            // Update UI Colors
            const lightCss = `#${preset.light.getHexString()}`;
            uiLayer.style.color = lightCss;
            uiLayer.style.borderColor = lightCss;
            titleBlock.style.color = lightCss;
            instructions.style.color = lightCss;
            leftHeader.style.color = lightCss;
            footerLeft.style.color = lightCss;

            // Update dropdown borders
            document.querySelectorAll('select').forEach(el => {
                el.style.borderColor = lightCss;
            });
        }

        monitorSelect.addEventListener('change', updateSettings);
        outputSelect.addEventListener('change', updateSettings);

        // Init
        updateSettings();


        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            if (logoGroup) {
                const time = Date.now() * 0.001;
                logoGroup.position.y = Math.sin(time) * 0.1;
                logoGroup.rotation.y = Math.sin(time * 0.5) * 0.1;
            }

            debrisGroup.rotation.y += 0.002;
            debrisGroup.rotation.x += 0.001;

            composer.render();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
            ditherPass.uniforms.uResolution.value.set(window.innerWidth, window.innerHeight);
        });

        animate();

    </script>
</body>
</html>
